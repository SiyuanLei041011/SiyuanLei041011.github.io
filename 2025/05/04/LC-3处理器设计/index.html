<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="顶层模块 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010">
<meta property="og:type" content="article">
<meta property="og:title" content="LC-3处理器设计">
<meta property="og:url" content="http://example.com/2025/05/04/LC-3%E5%A4%84%E7%90%86%E5%99%A8%E8%AE%BE%E8%AE%A1/index.html">
<meta property="og:site_name" content="SiyuanLei&#39;s Blog">
<meta property="og:description" content="顶层模块 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-17T10:47:50.027Z">
<meta property="article:author" content="SiyuanLei">
<meta property="article:tag" content="LC-3">
<meta property="article:tag" content="C语言">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/05/04/LC-3%E5%A4%84%E7%90%86%E5%99%A8%E8%AE%BE%E8%AE%A1/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2025/05/04/LC-3%E5%A4%84%E7%90%86%E5%99%A8%E8%AE%BE%E8%AE%A1/","path":"2025/05/04/LC-3处理器设计/","title":"LC-3处理器设计"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LC-3处理器设计 | SiyuanLei's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SiyuanLei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B6%E5%B1%82%E6%A8%A1%E5%9D%97"><span class="nav-number">1.</span> <span class="nav-text">顶层模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8D%95%E5%85%83"><span class="nav-number">2.</span> <span class="nav-text">控制单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E8%B7%AF%E5%8D%95%E5%85%83"><span class="nav-number">3.</span> <span class="nav-text">数据通路单元</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trap%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97"><span class="nav-number">4.</span> <span class="nav-text">TRAP处理模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%8E%A5%E5%8F%A3%E6%A8%A1%E5%9D%97"><span class="nav-number">5.</span> <span class="nav-text">内存接口模块</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="SiyuanLei"
      src="/images/femboy.jpg">
  <p class="site-author-name" itemprop="name">SiyuanLei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/SiyuanLei041011" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;SiyuanLei041011" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:SiyuanLei041011@gmail.com" title="E-Mail → mailto:SiyuanLei041011@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Esther041011" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Esther041011" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          Links
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://arxiv.org/" title="https:&#x2F;&#x2F;arxiv.org&#x2F;" rel="noopener" target="_blank">Arxiv</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://libgen.onl/library-genesis/" title="https:&#x2F;&#x2F;libgen.onl&#x2F;library-genesis&#x2F;" rel="noopener" target="_blank">LibGen</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://down.wlwkw.cn:8888/" title="http:&#x2F;&#x2F;down.wlwkw.cn:8888&#x2F;" rel="noopener" target="_blank">EBook</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/04/LC-3%E5%A4%84%E7%90%86%E5%99%A8%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/femboy.jpg">
      <meta itemprop="name" content="SiyuanLei">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SiyuanLei's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LC-3处理器设计 | SiyuanLei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LC-3处理器设计
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-05-04 00:00:00" itemprop="dateCreated datePublished" datetime="2025-05-04T00:00:00+08:00">2025-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-11-17 18:47:50" itemprop="dateModified" datetime="2025-11-17T18:47:50+08:00">2025-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/EE/" itemprop="url" rel="index"><span itemprop="name">EE</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/EE/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">计算机系统</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="顶层模块">顶层模块</h3>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> lc3_processor (</span><br><span class="line">    <span class="comment">// 时钟和复位信号</span></span><br><span class="line">    <span class="keyword">input</span> clk,                    <span class="comment">// 系统主时钟，驱动所有同步逻辑</span></span><br><span class="line">    <span class="keyword">input</span> reset,                  <span class="comment">// 全局复位信号，高电平有效，将处理器恢复到初始状态</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存接口信号</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] data_in,         <span class="comment">// 从内存读取的数据输入，16位宽度</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">15</span>:<span class="number">0</span>] data_out,       <span class="comment">// 要写入内存的数据输出，16位宽度</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">15</span>:<span class="number">0</span>] address,        <span class="comment">// 内存访问地址，16位可寻址64K内存空间</span></span><br><span class="line">    <span class="keyword">output</span> mem_read,              <span class="comment">// 内存读使能信号，高电平有效时执行读操作</span></span><br><span class="line">    <span class="keyword">output</span> mem_write,             <span class="comment">// 内存写使能信号，高电平有效时执行写操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调试和状态监控信号</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">15</span>:<span class="number">0</span>] pc,             <span class="comment">// 当前程序计数器值，用于调试和程序流跟踪</span></span><br><span class="line">    <span class="keyword">output</span> [<span class="number">15</span>:<span class="number">0</span>] ir              <span class="comment">// 当前指令寄存器值，用于调试和指令分析</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内部信号定义 - 数据通路相关</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] instruction;      <span class="comment">// 当前执行的指令，从指令寄存器直接输出</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] dr;                <span class="comment">// 目标寄存器地址，指令[11:9]，指定结果写入的寄存器</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] sr1;               <span class="comment">// 源寄存器1地址，指令[8:6]，ALU操作的第一操作数</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] sr2;               <span class="comment">// 源寄存器2地址，指令[2:0]，ALU操作的第二操作数</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">4</span>:<span class="number">0</span>] imm5;              <span class="comment">// 5位立即数，指令[4:0]，用于立即数指令的符号扩展</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">8</span>:<span class="number">0</span>] pc_offset9;        <span class="comment">// 9位PC偏移量，指令[8:0]，用于分支和跳转指令的地址计算</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">10</span>:<span class="number">0</span>] pc_offset11;      <span class="comment">// 11位PC偏移量，指令[10:0]，用于JSR指令的地址计算</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] trap_vector;       <span class="comment">// 8位陷阱向量，指令[7:0]，用于TRAP指令的服务程序寻址</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ALU和总线相关信号</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] alu_out;          <span class="comment">// ALU运算结果输出</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] bus_out;          <span class="comment">// 数据总线输出，连接寄存器文件写回端口</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] reg_out [<span class="number">0</span>:<span class="number">7</span>];    <span class="comment">// 寄存器文件输出数组，8个16位通用寄存器</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 条件码寄存器</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] nzp;               <span class="comment">// 条件码标志位：N(负)、Z(零)、P(正)，用于条件分支判断</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 控制信号定义 - 来自控制单元</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 寄存器加载使能信号</span></span><br><span class="line">    <span class="keyword">wire</span> ld_ir;                   <span class="comment">// 指令寄存器加载使能，高电平有效时更新IR</span></span><br><span class="line">    <span class="keyword">wire</span> ld_reg;                  <span class="comment">// 寄存器文件写使能，控制寄存器写入时机</span></span><br><span class="line">    <span class="keyword">wire</span> ld_cc;                   <span class="comment">// 条件码寄存器加载使能，高电平有效时更新NZP标志</span></span><br><span class="line">    <span class="keyword">wire</span> ld_pc;                   <span class="comment">// 程序计数器加载使能，高电平有效时更新PC</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ALU控制信号</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">1</span>:<span class="number">0</span>] alu_control;       <span class="comment">// ALU操作选择：</span></span><br><span class="line">                                  <span class="comment">// 00 = ADD, 01 = ADD立即数, 10 = AND, 11 = AND立即数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 多路选择器控制信号</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">1</span>:<span class="number">0</span>] pc_mux_sel;        <span class="comment">// PC多路选择器选择信号：</span></span><br><span class="line">                                  <span class="comment">// 00 = PC+1, 01 = PC+offset9, 10 = 寄存器值, 11 = 陷阱向量</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">1</span>:<span class="number">0</span>] bus_mux_sel;       <span class="comment">// 总线多路选择器选择信号：</span></span><br><span class="line">                                  <span class="comment">// 00 = 内存数据, 01 = ALU结果, 10 = PC值, 11 = LEA偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数据流控制信号</span></span><br><span class="line">    <span class="keyword">wire</span> reg_write;               <span class="comment">// 寄存器文件写使能，控制是否写入目标寄存器</span></span><br><span class="line">    <span class="keyword">wire</span> mem_to_reg;              <span class="comment">// 内存到寄存器选择，选择总线数据来源（内存或ALU）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指令类型标识信号（主要用于调试和控制逻辑）</span></span><br><span class="line">    <span class="keyword">wire</span> is_trap;                 <span class="comment">// TRAP指令标识，高电平表示当前为TRAP指令</span></span><br><span class="line">    <span class="keyword">wire</span> is_jsr;                  <span class="comment">// JSR/JSRR指令标识，高电平表示子程序调用指令</span></span><br><span class="line">    <span class="keyword">wire</span> is_br;                   <span class="comment">// BR指令标识，高电平表示条件分支指令</span></span><br><span class="line">    <span class="keyword">wire</span> is_jmp;                  <span class="comment">// JMP/RET指令标识，高电平表示无条件跳转指令</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 主要组件实例化</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 控制单元 - 产生所有控制信号</span></span><br><span class="line">    <span class="comment">// 根据当前指令和处理器状态生成相应的控制信号序列</span></span><br><span class="line">    control_unit ctrl (</span><br><span class="line">        <span class="comment">// 输入接口</span></span><br><span class="line">        <span class="variable">.clk</span>(clk),                        <span class="comment">// 时钟信号</span></span><br><span class="line">        <span class="variable">.reset</span>(reset),                    <span class="comment">// 复位信号</span></span><br><span class="line">        <span class="variable">.instruction</span>(instruction),        <span class="comment">// 当前指令输入</span></span><br><span class="line">        <span class="variable">.nzp</span>(nzp),                        <span class="comment">// 条件码标志输入</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 寄存器控制输出</span></span><br><span class="line">        <span class="variable">.ld_ir</span>(ld_ir),                    <span class="comment">// IR加载使能</span></span><br><span class="line">        <span class="variable">.ld_reg</span>(ld_reg),                  <span class="comment">// 寄存器文件写使能</span></span><br><span class="line">        <span class="variable">.ld_cc</span>(ld_cc),                    <span class="comment">// 条件码加载使能</span></span><br><span class="line">        <span class="variable">.ld_pc</span>(ld_pc),                    <span class="comment">// PC加载使能</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ALU和控制逻辑输出</span></span><br><span class="line">        <span class="variable">.alu_control</span>(alu_control),        <span class="comment">// ALU操作选择</span></span><br><span class="line">        <span class="variable">.pc_mux_sel</span>(pc_mux_sel),          <span class="comment">// PC多路选择器控制</span></span><br><span class="line">        <span class="variable">.bus_mux_sel</span>(bus_mux_sel),        <span class="comment">// 总线多路选择器控制</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 数据流控制输出</span></span><br><span class="line">        <span class="variable">.reg_write</span>(reg_write),            <span class="comment">// 寄存器写使能</span></span><br><span class="line">        <span class="variable">.mem_to_reg</span>(mem_to_reg),          <span class="comment">// 内存到寄存器选择</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 内存接口控制输出</span></span><br><span class="line">        <span class="variable">.mem_read</span>(mem_read),              <span class="comment">// 内存读使能</span></span><br><span class="line">        <span class="variable">.mem_write</span>(mem_write),            <span class="comment">// 内存写使能</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指令类型标识输出（调试用）</span></span><br><span class="line">        <span class="variable">.is_trap</span>(is_trap),                <span class="comment">// TRAP指令标识</span></span><br><span class="line">        <span class="variable">.is_jsr</span>(is_jsr),                  <span class="comment">// JSR指令标识</span></span><br><span class="line">        <span class="variable">.is_br</span>(is_br),                    <span class="comment">// BR指令标识</span></span><br><span class="line">        <span class="variable">.is_jmp</span>(is_jmp)                   <span class="comment">// JMP指令标识</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据通路 - 执行所有算术逻辑运算和数据传输</span></span><br><span class="line">    <span class="comment">// 包含ALU、寄存器文件、PC、MAR、MDR等核心组件</span></span><br><span class="line">    datapath dp (</span><br><span class="line">        <span class="comment">// 系统信号输入</span></span><br><span class="line">        <span class="variable">.clk</span>(clk),                        <span class="comment">// 系统时钟</span></span><br><span class="line">        <span class="variable">.reset</span>(reset),                    <span class="comment">// 系统复位</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指令和数据输入</span></span><br><span class="line">        <span class="variable">.instruction</span>(instruction),        <span class="comment">// 当前执行指令</span></span><br><span class="line">        <span class="variable">.data_in</span>(data_in),                <span class="comment">// 内存数据输入</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 控制信号输入</span></span><br><span class="line">        <span class="variable">.alu_control</span>(alu_control),        <span class="comment">// ALU操作控制</span></span><br><span class="line">        <span class="variable">.pc_mux_sel</span>(pc_mux_sel),          <span class="comment">// PC多路选择控制</span></span><br><span class="line">        <span class="variable">.bus_mux_sel</span>(bus_mux_sel),        <span class="comment">// 总线多路选择控制</span></span><br><span class="line">        <span class="variable">.reg_write</span>(reg_write),            <span class="comment">// 寄存器写使能</span></span><br><span class="line">        <span class="variable">.mem_to_reg</span>(mem_to_reg),          <span class="comment">// 内存到寄存器选择</span></span><br><span class="line">        <span class="variable">.ld_ir</span>(ld_ir),                    <span class="comment">// IR加载使能</span></span><br><span class="line">        <span class="variable">.ld_reg</span>(ld_reg),                  <span class="comment">// 寄存器加载使能</span></span><br><span class="line">        <span class="variable">.ld_cc</span>(ld_cc),                    <span class="comment">// 条件码加载使能</span></span><br><span class="line">        <span class="variable">.ld_pc</span>(ld_pc),                    <span class="comment">// PC加载使能</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 内存接口输出</span></span><br><span class="line">        <span class="variable">.data_out</span>(data_out),              <span class="comment">// 内存写数据</span></span><br><span class="line">        <span class="variable">.address</span>(address),                <span class="comment">// 内存地址</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 内部状态输出</span></span><br><span class="line">        <span class="variable">.alu_out</span>(alu_out),                <span class="comment">// ALU运算结果</span></span><br><span class="line">        <span class="variable">.bus_out</span>(bus_out),                <span class="comment">// 总线数据</span></span><br><span class="line">        <span class="variable">.nzp</span>(nzp),                        <span class="comment">// 条件码标志</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调试信号输出</span></span><br><span class="line">        <span class="variable">.pc</span>(pc),                          <span class="comment">// 当前PC值</span></span><br><span class="line">        <span class="variable">.ir</span>(ir)                           <span class="comment">// 当前IR值</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h3 id="控制单元">控制单元</h3>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> control_unit (</span><br><span class="line">    <span class="keyword">input</span> clk,                    <span class="comment">// 系统时钟信号</span></span><br><span class="line">    <span class="keyword">input</span> reset,                  <span class="comment">// 系统复位信号，高电平有效</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] instruction,     <span class="comment">// 当前执行的16位指令</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">2</span>:<span class="number">0</span>] nzp,              <span class="comment">// 条件码标志位：N(负)、Z(零)、P(正)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 寄存器加载控制信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> ld_ir,             <span class="comment">// 指令寄存器加载使能，控制IR更新</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> ld_reg,            <span class="comment">// 寄存器文件加载使能，控制寄存器写入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> ld_cc,             <span class="comment">// 条件码寄存器加载使能，控制NZP更新</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> ld_pc,             <span class="comment">// 程序计数器加载使能，控制PC更新</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ALU和总线控制信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] alu_control, <span class="comment">// ALU操作选择控制信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] pc_mux_sel,  <span class="comment">// PC多路选择器选择信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">1</span>:<span class="number">0</span>] bus_mux_sel, <span class="comment">// 总线多路选择器选择信号</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数据流控制信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> reg_write,         <span class="comment">// 寄存器写使能，控制寄存器文件写入</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> mem_to_reg,        <span class="comment">// 内存到寄存器选择，选择数据来源</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存访问控制信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> mem_read,          <span class="comment">// 内存读使能，控制内存读取操作</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> mem_write,         <span class="comment">// 内存写使能，控制内存写入操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指令类型标识信号（主要用于调试）</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> is_trap,           <span class="comment">// TRAP指令标识信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> is_jsr,            <span class="comment">// JSR指令标识信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> is_br,             <span class="comment">// BR指令标识信号</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> is_jmp             <span class="comment">// JMP指令标识信号</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// LC-3指令操作码定义</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">localparam</span> [<span class="number">3</span>:<span class="number">0</span>] </span><br><span class="line">        OP_ADD = <span class="number">4&#x27;b0001</span>,  <span class="comment">// 加法指令：寄存器+寄存器 或 寄存器+立即数</span></span><br><span class="line">        OP_AND = <span class="number">4&#x27;b0101</span>,  <span class="comment">// 逻辑与指令：寄存器&amp;寄存器 或 寄存器&amp;立即数</span></span><br><span class="line">        OP_BR  = <span class="number">4&#x27;b0000</span>,  <span class="comment">// 条件分支指令：根据条件码跳转到PC+offset9</span></span><br><span class="line">        OP_JMP = <span class="number">4&#x27;b1100</span>,  <span class="comment">// 跳转指令：跳转到寄存器指定的地址（包括RET）</span></span><br><span class="line">        OP_JSR = <span class="number">4&#x27;b0100</span>,  <span class="comment">// 跳转到子程序：保存返回地址到R7并跳转</span></span><br><span class="line">        OP_LD  = <span class="number">4&#x27;b0010</span>,  <span class="comment">// 加载指令：从内存地址PC+offset9加载数据到寄存器</span></span><br><span class="line">        OP_LDI = <span class="number">4&#x27;b1010</span>,  <span class="comment">// 间接加载指令：通过指针加载数据</span></span><br><span class="line">        OP_LDR = <span class="number">4&#x27;b0110</span>,  <span class="comment">// 基址偏移加载：从地址[基址寄存器+offset6]加载</span></span><br><span class="line">        OP_LEA = <span class="number">4&#x27;b1110</span>,  <span class="comment">// 加载有效地址：将PC+offset9的地址加载到寄存器</span></span><br><span class="line">        OP_NOT = <span class="number">4&#x27;b1001</span>,  <span class="comment">// 取反指令：对寄存器值按位取反</span></span><br><span class="line">        OP_ST  = <span class="number">4&#x27;b0011</span>,  <span class="comment">// 存储指令：将寄存器值存储到内存地址PC+offset9</span></span><br><span class="line">        OP_STI = <span class="number">4&#x27;b1011</span>,  <span class="comment">// 间接存储指令：通过指针存储数据</span></span><br><span class="line">        OP_STR = <span class="number">4&#x27;b0111</span>,  <span class="comment">// 基址偏移存储：存储到地址[基址寄存器+offset6]</span></span><br><span class="line">        OP_TRAP= <span class="number">4&#x27;b1111</span>;  <span class="comment">// 系统调用指令：执行指定的陷阱服务程序</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指令字段提取</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">3</span>:<span class="number">0</span>] opcode = instruction[<span class="number">15</span>:<span class="number">12</span>];    <span class="comment">// 操作码字段</span></span><br><span class="line">    <span class="keyword">wire</span> imm_mode = instruction[<span class="number">5</span>];            <span class="comment">// 立即数模式标志：1=立即数模式，0=寄存器模式</span></span><br><span class="line">    <span class="keyword">wire</span> jsr_mode = instruction[<span class="number">11</span>];           <span class="comment">// JSR模式标志：1=JSRR(寄存器)，0=JSR(PC相对)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 组合逻辑：指令译码与控制信号生成</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 默认控制信号赋值 - 确保所有输出都有确定值</span></span><br><span class="line">        ld_ir = <span class="number">1&#x27;b0</span>;           <span class="comment">// 默认不加载IR（在case外统一设置）</span></span><br><span class="line">        ld_reg = <span class="number">1&#x27;b0</span>;          <span class="comment">// 默认不加载寄存器文件</span></span><br><span class="line">        ld_cc = <span class="number">1&#x27;b0</span>;           <span class="comment">// 默认不更新条件码</span></span><br><span class="line">        ld_pc = <span class="number">1&#x27;b0</span>;           <span class="comment">// 默认PC递增（PC+1）</span></span><br><span class="line">        alu_control = <span class="number">2&#x27;b00</span>;    <span class="comment">// 默认ALU执行加法</span></span><br><span class="line">        pc_mux_sel = <span class="number">2&#x27;b00</span>;     <span class="comment">// 默认PC选择PC+1</span></span><br><span class="line">        bus_mux_sel = <span class="number">2&#x27;b00</span>;    <span class="comment">// 默认总线选择内存数据</span></span><br><span class="line">        reg_write = <span class="number">1&#x27;b0</span>;       <span class="comment">// 默认不写入寄存器文件</span></span><br><span class="line">        mem_to_reg = <span class="number">1&#x27;b0</span>;      <span class="comment">// 默认总线数据来自ALU</span></span><br><span class="line">        mem_read = <span class="number">1&#x27;b0</span>;        <span class="comment">// 默认不读取内存</span></span><br><span class="line">        mem_write = <span class="number">1&#x27;b0</span>;       <span class="comment">// 默认不写入内存</span></span><br><span class="line">        is_trap = <span class="number">1&#x27;b0</span>;         <span class="comment">// 默认非TRAP指令</span></span><br><span class="line">        is_jsr = <span class="number">1&#x27;b0</span>;          <span class="comment">// 默认非JSR指令</span></span><br><span class="line">        is_br = <span class="number">1&#x27;b0</span>;           <span class="comment">// 默认非BR指令</span></span><br><span class="line">        is_jmp = <span class="number">1&#x27;b0</span>;          <span class="comment">// 默认非JMP指令</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据操作码生成相应的控制信号</span></span><br><span class="line">        <span class="keyword">case</span> (opcode)</span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// ADD指令：目标寄存器 ← 源寄存器1 + 源寄存器2/立即数</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_ADD: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// ALU控制：根据imm_mode选择寄存器相加或立即数相加</span></span><br><span class="line">                alu_control = (imm_mode) ? <span class="number">2&#x27;b01</span> : <span class="number">2&#x27;b00</span>; </span><br><span class="line">                <span class="comment">// 总线选择：将ALU运算结果送到总线</span></span><br><span class="line">                bus_mux_sel = <span class="number">2&#x27;b01</span>; </span><br><span class="line">                <span class="comment">// 寄存器控制：允许写入目标寄存器并更新条件码</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_cc = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// AND指令：目标寄存器 ← 源寄存器1 &amp; 源寄存器2/立即数</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_AND: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// ALU控制：根据imm_mode选择寄存器相与或立即数相与</span></span><br><span class="line">                alu_control = (imm_mode) ? <span class="number">2&#x27;b11</span> : <span class="number">2&#x27;b10</span>;</span><br><span class="line">                <span class="comment">// 总线选择：将ALU运算结果送到总线</span></span><br><span class="line">                bus_mux_sel = <span class="number">2&#x27;b01</span>;</span><br><span class="line">                <span class="comment">// 寄存器控制：允许写入目标寄存器并更新条件码</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_cc = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// NOT指令：目标寄存器 ← ~源寄存器1（按位取反）</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_NOT: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// ALU控制：NOT操作实际上使用AND逻辑的特殊处理</span></span><br><span class="line">                alu_control = <span class="number">2&#x27;b10</span>; </span><br><span class="line">                <span class="comment">// 总线选择：将ALU运算结果送到总线</span></span><br><span class="line">                bus_mux_sel = <span class="number">2&#x27;b01</span>;</span><br><span class="line">                <span class="comment">// 寄存器控制：允许写入目标寄存器并更新条件码</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_cc = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// BR指令：条件分支，如果条件码匹配则PC ← PC + 符号扩展(offset9)</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_BR: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 设置BR指令标识</span></span><br><span class="line">                is_br = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 检查条件码是否匹配：instruction[11:9]对应nzp[2:0]</span></span><br><span class="line">                <span class="comment">// instruction[11]=1且N=1，或instruction[10]=1且Z=1，或instruction[9]=1且P=1</span></span><br><span class="line">                <span class="keyword">if</span> ((instruction[<span class="number">11</span>] &amp; nzp[<span class="number">2</span>]) |   <span class="comment">// 负条件匹配</span></span><br><span class="line">                    (instruction[<span class="number">10</span>] &amp; nzp[<span class="number">1</span>]) |   <span class="comment">// 零条件匹配</span></span><br><span class="line">                    (instruction[<span class="number">9</span>] &amp; nzp[<span class="number">0</span>]))     <span class="comment">// 正条件匹配</span></span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    <span class="comment">// 条件满足：选择PC+offset9作为下一条指令地址</span></span><br><span class="line">                    pc_mux_sel = <span class="number">2&#x27;b01</span>; </span><br><span class="line">                    ld_pc = <span class="number">1&#x27;b1</span>;        <span class="comment">// 允许更新PC</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="comment">// 如果不满足条件，PC保持默认的PC+1</span></span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// JMP指令：无条件跳转，PC ← 寄存器值（RET是JMP R7的特殊情况）</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_JMP: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 设置JMP指令标识</span></span><br><span class="line">                is_jmp = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// PC控制：选择寄存器值作为下一条指令地址</span></span><br><span class="line">                pc_mux_sel = <span class="number">2&#x27;b10</span>; </span><br><span class="line">                ld_pc = <span class="number">1&#x27;b1</span>;            <span class="comment">// 允许更新PC</span></span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// JSR/JSRR指令：跳转到子程序</span></span><br><span class="line">            <span class="comment">// JSR: PC ← PC + 符号扩展(offset11), R7 ← 当前PC（返回地址）</span></span><br><span class="line">            <span class="comment">// JSRR: PC ← 寄存器值, R7 ← 当前PC（返回地址）</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_JSR: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 设置JSR指令标识</span></span><br><span class="line">                is_jsr = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 保存返回地址到R7：将当前PC值通过总线写入R7</span></span><br><span class="line">                bus_mux_sel = <span class="number">2&#x27;b10</span>;     <span class="comment">// 选择PC值送到总线</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;        <span class="comment">// 允许写入寄存器</span></span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;           <span class="comment">// 加载寄存器文件</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 根据jsr_mode选择跳转方式</span></span><br><span class="line">                <span class="keyword">if</span> (jsr_mode) <span class="keyword">begin</span></span><br><span class="line">                    <span class="comment">// JSRR模式：跳转到寄存器指定的地址</span></span><br><span class="line">                    pc_mux_sel = <span class="number">2&#x27;b10</span>;  <span class="comment">// 选择寄存器值</span></span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    <span class="comment">// JSR模式：跳转到PC+offset11</span></span><br><span class="line">                    pc_mux_sel = <span class="number">2&#x27;b01</span>;  <span class="comment">// 选择PC+offset</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                ld_pc = <span class="number">1&#x27;b1</span>;            <span class="comment">// 允许更新PC</span></span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// TRAP指令：系统调用</span></span><br><span class="line">            <span class="comment">// R7 ← 当前PC（返回地址），PC ← 陷阱向量表[trapvect8]</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_TRAP: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 设置TRAP指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 保存返回地址到R7：将当前PC值通过总线写入R7</span></span><br><span class="line">                bus_mux_sel = <span class="number">2&#x27;b10</span>;     <span class="comment">// 选择PC值送到总线</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;        <span class="comment">// 允许写入寄存器</span></span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;           <span class="comment">// 加载寄存器文件</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 跳转到陷阱服务程序：通过陷阱向量表查找服务程序地址</span></span><br><span class="line">                pc_mux_sel = <span class="number">2&#x27;b11</span>;      <span class="comment">// 选择陷阱向量地址</span></span><br><span class="line">                ld_pc = <span class="number">1&#x27;b1</span>;            <span class="comment">// 允许更新PC</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 内存控制：可能需要读取陷阱向量表中的服务程序地址</span></span><br><span class="line">                mem_read = <span class="number">1&#x27;b1</span>;         <span class="comment">// 使能内存读取</span></span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// LD指令：加载数据，目标寄存器 ← 内存[PC + 符号扩展(offset9)]</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_LD: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 内存控制：从PC+offset9地址读取数据</span></span><br><span class="line">                mem_read = <span class="number">1&#x27;b1</span>;         <span class="comment">// 使能内存读取</span></span><br><span class="line">                mem_to_reg = <span class="number">1&#x27;b1</span>;       <span class="comment">// 总线数据来自内存（而不是ALU）</span></span><br><span class="line">                <span class="comment">// 寄存器控制：将内存数据写入目标寄存器并更新条件码</span></span><br><span class="line">                reg_write = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_reg = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                ld_cc = <span class="number">1&#x27;b1</span>;</span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            <span class="comment">// ST指令：存储数据，内存[PC + 符号扩展(offset9)] ← 源寄存器</span></span><br><span class="line">            <span class="comment">// =================================================================</span></span><br><span class="line">            OP_ST: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 内存控制：向PC+offset9地址写入寄存器数据</span></span><br><span class="line">                mem_write = <span class="number">1&#x27;b1</span>;        <span class="comment">// 使能内存写入</span></span><br><span class="line">                <span class="comment">// 指令标识</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 其他指令实现（LDI, LDR, LEA, STI, STR等）...</span></span><br><span class="line">            <span class="comment">// 这里可以继续添加其他指令的case分支</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 未定义操作码或未实现指令的默认处理</span></span><br><span class="line">                <span class="comment">// 所有信号保持默认值，确保系统稳定</span></span><br><span class="line">                is_trap = <span class="number">1&#x27;b0</span>; is_jsr = <span class="number">1&#x27;b0</span>; is_br = <span class="number">1&#x27;b0</span>; is_jmp = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 每个时钟周期都取指：总是加载指令寄存器</span></span><br><span class="line">        <span class="comment">// 这确保了下一条指令能够及时进入流水线</span></span><br><span class="line">        ld_ir = <span class="number">1&#x27;b1</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h3 id="数据通路单元">数据通路单元</h3>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> datapath (</span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 输入端口定义</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">input</span> clk,                    <span class="comment">// 系统时钟信号，驱动所有同步逻辑</span></span><br><span class="line">    <span class="keyword">input</span> reset,                  <span class="comment">// 全局复位信号，高电平有效，复位所有寄存器</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] instruction,     <span class="comment">// 当前执行的16位指令字</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] data_in,         <span class="comment">// 从内存读取的16位数据输入</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 控制信号输入</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>] alu_control,      <span class="comment">// ALU操作控制信号：00=ADD,01=ADD立即数,10=AND,11=AND立即数</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>] pc_mux_sel,       <span class="comment">// PC多路选择器控制：00=PC+1,01=PC+offset,10=寄存器,11=陷阱向量</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">1</span>:<span class="number">0</span>] bus_mux_sel,      <span class="comment">// 总线多路选择器控制：00=内存,01=ALU,10=PC,11=LEA偏移量</span></span><br><span class="line">    <span class="keyword">input</span> reg_write,              <span class="comment">// 寄存器写使能信号，控制是否写入寄存器文件</span></span><br><span class="line">    <span class="keyword">input</span> mem_to_reg,             <span class="comment">// 内存到寄存器选择，选择写回数据来源（内存或ALU）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 寄存器加载控制信号</span></span><br><span class="line">    <span class="keyword">input</span> ld_ir,                  <span class="comment">// 指令寄存器加载使能</span></span><br><span class="line">    <span class="keyword">input</span> ld_reg,                 <span class="comment">// 寄存器文件加载使能</span></span><br><span class="line">    <span class="keyword">input</span> ld_cc,                  <span class="comment">// 条件码寄存器加载使能</span></span><br><span class="line">    <span class="keyword">input</span> ld_pc,                  <span class="comment">// 程序计数器加载使能</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 输出端口定义</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] data_out,   <span class="comment">// 要写入内存的16位数据输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] address,    <span class="comment">// 内存访问地址输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] alu_out,    <span class="comment">// ALU运算结果输出，用于调试和后续处理</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] bus_out,    <span class="comment">// 数据总线输出，连接寄存器写回端口</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">2</span>:<span class="number">0</span>] nzp,         <span class="comment">// 条件码标志位输出：N(负), Z(零), P(正)</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] pc,         <span class="comment">// 当前程序计数器值，用于调试</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] ir          <span class="comment">// 当前指令寄存器值，用于调试</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 寄存器文件定义 - 8个16位通用寄存器</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] reg_file [<span class="number">0</span>:<span class="number">7</span>];    <span class="comment">// R0-R7寄存器文件，支持同时读写</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内部信号定义</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 寄存器读取输出</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] sr1_out, sr2_out; <span class="comment">// 源寄存器1和源寄存器2的读取数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 符号扩展立即数</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] imm5_sext;        <span class="comment">// 5位立即数符号扩展结果</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] offset9_sext;     <span class="comment">// 9位偏移量符号扩展结果</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] offset11_sext;    <span class="comment">// 11位偏移量符号扩展结果</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] offset6_sext;     <span class="comment">// 6位偏移量符号扩展结果（用于LDR/STR）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] trap_vector_addr; <span class="comment">// 陷阱向量地址</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// PC控制信号</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] next_pc;          <span class="comment">// 下一条指令地址</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 指令解码 - 从指令字中提取各个字段</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] dr = instruction[<span class="number">11</span>:<span class="number">9</span>];    <span class="comment">// 目标寄存器地址（写入结果的寄存器）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] sr1 = instruction[<span class="number">8</span>:<span class="number">6</span>];    <span class="comment">// 源寄存器1地址（第一个操作数）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] sr2 = instruction[<span class="number">2</span>:<span class="number">0</span>];    <span class="comment">// 源寄存器2地址（第二个操作数）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">4</span>:<span class="number">0</span>] imm5 = instruction[<span class="number">4</span>:<span class="number">0</span>];   <span class="comment">// 5位立即数（用于ADD/AND立即数模式）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">8</span>:<span class="number">0</span>] offset9 = instruction[<span class="number">8</span>:<span class="number">0</span>]; <span class="comment">// 9位偏移量（用于LD/ST/BR/LEA等指令）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">10</span>:<span class="number">0</span>] offset11 = instruction[<span class="number">10</span>:<span class="number">0</span>]; <span class="comment">// 11位偏移量（用于JSR指令）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">5</span>:<span class="number">0</span>] offset6 = instruction[<span class="number">5</span>:<span class="number">0</span>]; <span class="comment">// 6位偏移量（用于LDR/STR指令）</span></span><br><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] trap_vector = instruction[<span class="number">7</span>:<span class="number">0</span>]; <span class="comment">// 8位陷阱向量（用于TRAP指令）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 符号扩展单元 - 将短位宽有符号数扩展为16位</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">assign</span> imm5_sext = &#123;&#123;<span class="number">11</span>&#123;imm5[<span class="number">4</span>]&#125;&#125;, imm5&#125;;           <span class="comment">// 5位立即数符号扩展</span></span><br><span class="line">    <span class="keyword">assign</span> offset9_sext = &#123;&#123;<span class="number">7</span>&#123;offset9[<span class="number">8</span>]&#125;&#125;, offset9&#125;;   <span class="comment">// 9位偏移量符号扩展</span></span><br><span class="line">    <span class="keyword">assign</span> offset11_sext = &#123;&#123;<span class="number">5</span>&#123;offset11[<span class="number">10</span>]&#125;&#125;, offset11&#125;; <span class="comment">// 11位偏移量符号扩展</span></span><br><span class="line">    <span class="keyword">assign</span> offset6_sext = &#123;&#123;<span class="number">10</span>&#123;offset6[<span class="number">5</span>]&#125;&#125;, offset6&#125;;  <span class="comment">// 6位偏移量符号扩展</span></span><br><span class="line">    <span class="keyword">assign</span> trap_vector_addr = &#123;<span class="number">8&#x27;b0</span>, trap_vector&#125;;      <span class="comment">// 陷阱向量零扩展为16位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 寄存器文件读取 - 组合逻辑读取，无时钟延迟</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">assign</span> sr1_out = reg_file[sr1];  <span class="comment">// 从SR1指定寄存器读取数据</span></span><br><span class="line">    <span class="keyword">assign</span> sr2_out = reg_file[sr2];  <span class="comment">// 从SR2指定寄存器读取数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 算术逻辑单元(ALU) - 执行所有算术和逻辑运算</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 根据ALU控制信号执行相应的运算</span></span><br><span class="line">        <span class="keyword">case</span> (alu_control)</span><br><span class="line">            <span class="number">2&#x27;b00</span>: alu_out = sr1_out + sr2_out;           <span class="comment">// 寄存器加法：SR1 + SR2</span></span><br><span class="line">            <span class="number">2&#x27;b01</span>: alu_out = sr1_out + imm5_sext;         <span class="comment">// 立即数加法：SR1 + 立即数</span></span><br><span class="line">            <span class="number">2&#x27;b10</span>: alu_out = sr1_out &amp; sr2_out;           <span class="comment">// 寄存器逻辑与：SR1 &amp; SR2</span></span><br><span class="line">            <span class="number">2&#x27;b11</span>: alu_out = sr1_out &amp; imm5_sext;         <span class="comment">// 立即数逻辑与：SR1 &amp; 立即数</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// NOT指令特殊处理：对源寄存器1按位取反</span></span><br><span class="line">        <span class="comment">// NOT指令的操作码是1001，它使用ALU的AND逻辑但需要特殊处理结果</span></span><br><span class="line">        <span class="keyword">if</span> (instruction[<span class="number">15</span>:<span class="number">12</span>] == <span class="number">4&#x27;b1001</span>) <span class="keyword">begin</span> <span class="comment">// NOT指令</span></span><br><span class="line">            alu_out = ~sr1_out;  <span class="comment">// 按位取反操作</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 总线多路选择器 - 选择写入寄存器文件的数据来源</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (bus_mux_sel)</span><br><span class="line">            <span class="number">2&#x27;b00</span>: bus_out = data_in;     <span class="comment">// 选择内存数据（用于LD/LDI/LDR指令）</span></span><br><span class="line">            <span class="number">2&#x27;b01</span>: bus_out = alu_out;     <span class="comment">// 选择ALU运算结果（用于ADD/AND/NOT指令）</span></span><br><span class="line">            <span class="number">2&#x27;b10</span>: bus_out = pc;          <span class="comment">// 选择PC值（用于JSR/TRAP保存返回地址）</span></span><br><span class="line">            <span class="number">2&#x27;b11</span>: bus_out = offset9_sext; <span class="comment">// 选择LEA偏移量（用于LEA指令加载有效地址）</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// PC多路选择器 - 决定下一条指令的地址</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">assign</span> next_pc = (pc_mux_sel == <span class="number">2&#x27;b00</span>) ? pc + <span class="number">16&#x27;b1</span> :           <span class="comment">// 顺序执行：PC + 1</span></span><br><span class="line">                    (pc_mux_sel == <span class="number">2&#x27;b01</span>) ? pc + offset9_sext :    <span class="comment">// 分支跳转：PC + 符号扩展offset9</span></span><br><span class="line">                    (pc_mux_sel == <span class="number">2&#x27;b10</span>) ? sr1_out :              <span class="comment">// 寄存器跳转：使用寄存器值作为目标地址</span></span><br><span class="line">                    &#123;<span class="number">8&#x27;b0</span>, trap_vector&#125;;                          <span class="comment">// 陷阱调用：使用陷阱向量作为目标地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 地址生成逻辑 - 计算内存访问地址</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span> (instruction[<span class="number">15</span>:<span class="number">12</span>])  <span class="comment">// 根据操作码选择地址生成方式</span></span><br><span class="line">            <span class="number">4&#x27;b0010</span>, <span class="number">4&#x27;b0011</span>: address = pc + offset9_sext;  <span class="comment">// LD/ST：PC相对寻址</span></span><br><span class="line">            <span class="number">4&#x27;b1010</span>, <span class="number">4&#x27;b1011</span>: address = pc + offset9_sext;  <span class="comment">// LDI/STI：PC相对间接寻址</span></span><br><span class="line">            <span class="number">4&#x27;b0110</span>, <span class="number">4&#x27;b0111</span>: address = sr1_out + offset6_sext; <span class="comment">// LDR/STR：基址+偏移寻址</span></span><br><span class="line">            <span class="number">4&#x27;b1111</span>: address = trap_vector_addr;            <span class="comment">// TRAP：陷阱向量表地址</span></span><br><span class="line">            <span class="keyword">default</span>: address = pc;                          <span class="comment">// 默认使用PC作为地址</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 数据输出逻辑 - 准备要写入内存的数据</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(*) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 对于存储指令(ST/STI/STR)，将要存储的寄存器值送到data_out</span></span><br><span class="line">        data_out = sr1_out; <span class="comment">// 使用源寄存器1的值作为内存写入数据</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 条件码逻辑 - 跟踪最近写入结果的符号状态</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 复位时初始化条件码为零标志</span></span><br><span class="line">            nzp &lt;= <span class="number">3&#x27;b010</span>; <span class="comment">// 初始化为Z(零)标志</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (ld_cc) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 当条件码加载使能有效时，根据总线数据的符号更新条件码</span></span><br><span class="line">            <span class="keyword">if</span> (bus_out[<span class="number">15</span>] == <span class="number">1&#x27;b1</span>)        <span class="comment">// 检查最高位（符号位）</span></span><br><span class="line">                nzp &lt;= <span class="number">3&#x27;b100</span>;              <span class="comment">// 负数：设置N标志</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (bus_out == <span class="number">16&#x27;b0</span>)      <span class="comment">// 检查是否为零</span></span><br><span class="line">                nzp &lt;= <span class="number">3&#x27;b010</span>;              <span class="comment">// 零：设置Z标志</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                nzp &lt;= <span class="number">3&#x27;b001</span>;              <span class="comment">// 正数：设置P标志</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">// 如果ld_cc无效，条件码保持原值</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 程序计数器(PC) - 跟踪当前执行指令的地址</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 复位时PC初始化为LC-3标准起始地址0x3000</span></span><br><span class="line">            pc &lt;= <span class="number">16&#x27;h3000</span>; </span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (ld_pc) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 当PC加载使能有效时，更新为多路选择器选择的下一地址</span></span><br><span class="line">            pc &lt;= next_pc;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 默认情况下，PC每个周期递增1（顺序执行）</span></span><br><span class="line">            pc &lt;= pc + <span class="number">16&#x27;b1</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 指令寄存器(IR) - 保存当前正在执行的指令</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 复位时清除指令寄存器</span></span><br><span class="line">            ir &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (ld_ir) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 当IR加载使能有效时，锁存当前指令</span></span><br><span class="line">            ir &lt;= instruction;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">// 如果ld_ir无效，IR保持原值</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 寄存器文件写回逻辑 - 将数据写入目标寄存器</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">integer</span> i;  <span class="comment">// 循环变量，用于复位时初始化所有寄存器</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 复位时将所有8个寄存器清零</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i = i + <span class="number">1</span>)</span><br><span class="line">                reg_file[i] &lt;= <span class="number">16&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> (reg_write &amp;&amp; ld_reg) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 当寄存器写使能和加载使能都有效时，执行写回操作</span></span><br><span class="line">            <span class="keyword">if</span> (ir[<span class="number">15</span>:<span class="number">12</span>] == <span class="number">4&#x27;b1111</span>) <span class="keyword">begin</span> </span><br><span class="line">                <span class="comment">// TRAP指令特殊处理：总是将返回地址写入R7</span></span><br><span class="line">                reg_file[<span class="number">3&#x27;b111</span>] &lt;= bus_out; <span class="comment">// R7 = 当前PC值（返回地址）</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 普通指令：根据mem_to_reg选择数据来源写入目标寄存器</span></span><br><span class="line">                reg_file[dr] &lt;= (mem_to_reg) ? data_in : bus_out;</span><br><span class="line">                <span class="comment">// mem_to_reg=1：从内存读取的数据(data_in)</span></span><br><span class="line">                <span class="comment">// mem_to_reg=0：从总线来的数据(bus_out，可能是ALU结果或PC值)</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">// 如果写使能无效，寄存器文件保持原值</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<h3 id="trap处理模块">TRAP处理模块</h3>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// TRAP处理模块 (Trap Handler)</span></span><br><span class="line"><span class="comment">// 功能：处理LC-3处理器的系统调用(TRAP)指令，实现陷阱向量到服务程序的地址转换</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="keyword">module</span> trap_handler (</span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 输入端口</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">input</span> clk,                    <span class="comment">// 系统时钟信号，用于同步陷阱处理操作</span></span><br><span class="line">    <span class="keyword">input</span> reset,                  <span class="comment">// 全局复位信号，高电平有效，复位所有内部状态</span></span><br><span class="line">    <span class="keyword">input</span> trap_enable,            <span class="comment">// TRAP使能信号，高电平表示当前正在执行TRAP指令</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">7</span>:<span class="number">0</span>] trap_vector,      <span class="comment">// 8位陷阱向量，来自TRAP指令的[7:0]字段，用于索引陷阱服务程序</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] current_pc,      <span class="comment">// 当前程序计数器值，用于保存为返回地址</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 输出端口</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] trap_address, <span class="comment">// 16位陷阱服务程序地址，输出到PC多路选择器</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> save_pc,           <span class="comment">// 保存PC使能信号，通知数据通路保存返回地址到R7</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] return_addr   <span class="comment">// 返回地址值，即TRAP指令执行时的PC值</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内部存储器：TRAP向量表</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 256x16位陷阱向量表，将8位陷阱向量映射到16位服务程序起始地址</span></span><br><span class="line">    <span class="comment">// 索引范围：0-255，对应TRAP指令的trapvect8字段的所有可能值</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] trap_vector_table [<span class="number">0</span>:<span class="number">255</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 向量表初始化 - 预定义标准LC-3陷阱服务程序地址</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 初始化所有向量表项为0（安全默认值）</span></span><br><span class="line">        <span class="comment">// 在实际实现中，可能需要更完整的初始化</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">integer</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            trap_vector_table[i] = <span class="number">16&#x27;h0000</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// =====================================================================</span></span><br><span class="line">        <span class="comment">// LC-3标准陷阱向量定义</span></span><br><span class="line">        <span class="comment">// =====================================================================</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 字符输入陷阱服务</span></span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h20</span>] = <span class="number">16&#x27;h0430</span>; <span class="comment">// GETC - 从键盘读取单个字符到R0</span></span><br><span class="line">        <span class="comment">// 功能：等待键盘输入，将输入的ASCII字符存入R0[7:0]，R0[15:8]清零</span></span><br><span class="line">        <span class="comment">// 不回显字符到显示器</span></span><br><span class="line">        </span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h21</span>] = <span class="number">16&#x27;h0450</span>; <span class="comment">// OUT - 将R0[7:0]中的字符输出到显示器</span></span><br><span class="line">        <span class="comment">// 功能：将R0寄存器低8位的ASCII字符发送到显示器输出</span></span><br><span class="line">        <span class="comment">// 注意：字符必须位于R0[7:0]，高8位被忽略</span></span><br><span class="line">        </span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h22</span>] = <span class="number">16&#x27;h04A0</span>; <span class="comment">// PUTS - 输出以空字符结尾的字符串</span></span><br><span class="line">        <span class="comment">// 功能：从R0指定的内存地址开始，逐个输出字符直到遇到空字符(0x0000)</span></span><br><span class="line">        <span class="comment">// 输入：R0包含字符串起始地址</span></span><br><span class="line">        <span class="comment">// 输出：字符串内容显示在显示器上</span></span><br><span class="line">        </span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h23</span>] = <span class="number">16&#x27;h04E0</span>; <span class="comment">// IN - 输入字符并回显</span></span><br><span class="line">        <span class="comment">// 功能：等待键盘输入，将字符存入R0[7:0]并在显示器上回显该字符</span></span><br><span class="line">        <span class="comment">// 相当于GETC和OUT的组合，但作为原子操作</span></span><br><span class="line">        </span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h24</span>] = <span class="number">16&#x27;hFD70</span>; <span class="comment">// PUTSP - 输出打包的字节字符串</span></span><br><span class="line">        <span class="comment">// 功能：输出内存中的打包字符串（每个16位字包含2个ASCII字符）</span></span><br><span class="line">        <span class="comment">// 输入：R0包含字符串起始地址</span></span><br><span class="line">        <span class="comment">// 输出：解包后的字符串显示在显示器上</span></span><br><span class="line">        </span><br><span class="line">        trap_vector_table[<span class="number">8&#x27;h25</span>] = <span class="number">16&#x27;hFD00</span>; <span class="comment">// HALT - 停止程序执行</span></span><br><span class="line">        <span class="comment">// 功能：停止处理器执行，通常通过设置特定的状态位来实现</span></span><br><span class="line">        <span class="comment">// 在模拟器中会停止模拟，在实际硬件中可能进入低功耗状态</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// =====================================================================</span></span><br><span class="line">        <span class="comment">// 可扩展的其他陷阱向量（根据需要添加）</span></span><br><span class="line">        <span class="comment">// =====================================================================</span></span><br><span class="line">        <span class="comment">// trap_vector_table[8&#x27;h26] = 16&#x27;hXXXX; // 预留用户自定义陷阱</span></span><br><span class="line">        <span class="comment">// trap_vector_table[8&#x27;h27] = 16&#x27;hXXXX; // 预留用户自定义陷阱</span></span><br><span class="line">        <span class="comment">// ... 可以继续添加其他陷阱服务程序地址</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// TRAP处理状态机 - 同步逻辑</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位处理：清除所有输出信号和状态</span></span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            trap_address &lt;= <span class="number">16&#x27;b0</span>;    <span class="comment">// 复位陷阱地址输出</span></span><br><span class="line">            save_pc &lt;= <span class="number">1&#x27;b0</span>;          <span class="comment">// 复位保存PC使能信号</span></span><br><span class="line">            return_addr &lt;= <span class="number">16&#x27;b0</span>;     <span class="comment">// 复位返回地址寄存器</span></span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// TRAP指令使能处理</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (trap_enable) <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 阶段1：保存返回地址</span></span><br><span class="line">            <span class="comment">// 将当前PC值（TRAP指令地址+1）保存到返回地址寄存器</span></span><br><span class="line">            return_addr &lt;= current_pc;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 产生保存PC使能信号，通知数据通路将返回地址写入R7寄存器</span></span><br><span class="line">            save_pc &lt;= <span class="number">1&#x27;b1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 阶段2：查找陷阱服务程序地址</span></span><br><span class="line">            <span class="comment">// 使用8位陷阱向量作为索引，从陷阱向量表中查找对应的服务程序起始地址</span></span><br><span class="line">            <span class="comment">// trap_vector的范围是0-255，正好对应向量表的256个条目</span></span><br><span class="line">            trap_address &lt;= trap_vector_table[trap_vector];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 注意：这里假设陷阱向量表已经正确初始化，包含了有效的服务程序地址</span></span><br><span class="line">            <span class="comment">// 如果访问未初始化的向量表项，将返回0，可能导致处理器执行地址0的指令</span></span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 非TRAP状态处理</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 清除保存PC使能信号，避免在其他指令执行时误保存PC</span></span><br><span class="line">            save_pc &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 注意：trap_address和return_addr保持它们之前的值</span></span><br><span class="line">            <span class="comment">// 这确保在TRAP处理期间输出稳定性</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 模块功能详细说明</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">TRAP处理模块在LC-3系统中的作用：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1. TRAP指令执行流程：</span></span><br><span class="line"><span class="comment">   - 当处理器遇到TRAP指令时，控制单元产生trap_enable信号</span></span><br><span class="line"><span class="comment">   - TRAP处理模块接收trap_vector（来自指令低8位）和current_pc</span></span><br><span class="line"><span class="comment">   - 模块执行两个主要操作：</span></span><br><span class="line"><span class="comment">        a. 保存返回地址（current_pc）到return_addr，并产生save_pc信号</span></span><br><span class="line"><span class="comment">        b. 通过向量表查找对应的陷阱服务程序地址到trap_address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2. 陷阱向量表机制：</span></span><br><span class="line"><span class="comment">   - 类似于现代操作系统中的中断向量表或系统调用表</span></span><br><span class="line"><span class="comment">   - 将用户可见的8位陷阱号映射到系统内部的服务程序入口地址</span></span><br><span class="line"><span class="comment">   - 提供硬件与操作系统服务之间的标准化接口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">3. 标准LC-3陷阱服务：</span></span><br><span class="line"><span class="comment">   - GETC (0x20): 输入单个字符，用于实现getchar()类似功能</span></span><br><span class="line"><span class="comment">   - OUT  (0x21): 输出单个字符，用于实现putchar()类似功能  </span></span><br><span class="line"><span class="comment">   - PUTS (0x22): 输出字符串，用于实现printf()类似功能</span></span><br><span class="line"><span class="comment">   - IN   (0x23): 输入并回显，用于实现交互式输入</span></span><br><span class="line"><span class="comment">   - PUTSP(0x24): 输出打包字符串，优化存储空间</span></span><br><span class="line"><span class="comment">   - HALT (0x25): 停止执行，用于程序正常退出</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">4. 关键时序：</span></span><br><span class="line"><span class="comment">   - 所有操作在时钟上升沿同步进行</span></span><br><span class="line"><span class="comment">   - trap_enable有效后，在下一个时钟周期即可获得服务程序地址</span></span><br><span class="line"><span class="comment">   - save_pc信号仅在一个时钟周期内有效，确保返回地址正确保存</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">5. 扩展性：</span></span><br><span class="line"><span class="comment">   - 可以通过添加更多向量表条目来支持自定义陷阱服务</span></span><br><span class="line"><span class="comment">   - 支持用户定义的操作系统服务调用</span></span><br><span class="line"><span class="comment">   - 为高级语言运行时库提供底层支持</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// 在汇编程序中使用TRAP指令的例子：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        ; 输出字符串 &quot;Hello, World!&quot;</span></span><br><span class="line"><span class="comment">        LEA R0, HELLO_STR  ; 将字符串地址加载到R0</span></span><br><span class="line"><span class="comment">        TRAP x22           ; 调用PUTS陷阱服务（陷阱向量0x22）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        ; 停止程序执行</span></span><br><span class="line"><span class="comment">        TRAP x25           ; 调用HALT陷阱服务（陷阱向量0x25）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">HELLO_STR .STRINGZ &quot;Hello, World!&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 对应的处理器操作：</span></span><br><span class="line"><span class="comment">// 1. 执行TRAP x22指令时，trap_vector = 8&#x27;h22</span></span><br><span class="line"><span class="comment">// 2. TRAP处理模块查找向量表，得到trap_address = 16&#x27;h04A0</span></span><br><span class="line"><span class="comment">// 3. PC跳转到0x04A0执行PUTS服务程序</span></span><br><span class="line"><span class="comment">// 4. 同时将返回地址（TRAP指令地址+1）保存到R7</span></span><br><span class="line"><span class="comment">// 5. 服务程序执行完成后，通过RET（JMP R7）返回主程序</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 注意事项</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. 陷阱向量表必须在系统启动时正确初始化，否则可能导致未定义行为</span></span><br><span class="line"><span class="comment">2. 陷阱服务程序地址应该指向有效的可执行代码区域</span></span><br><span class="line"><span class="comment">3. 在真实的LC-3实现中，陷阱服务程序通常存储在系统ROM中</span></span><br><span class="line"><span class="comment">4. 该模块假设单周期TRAP处理，在实际多周期实现中可能需要更复杂的状态机</span></span><br><span class="line"><span class="comment">5. 复位时确保所有信号处于已知状态，避免系统启动时意外触发陷阱处理</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="内存接口模块">内存接口模块</h3>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 内存接口模块 (Memory Interface)</span></span><br><span class="line"><span class="comment">// 功能：LC-3处理器的内存子系统，管理64Kx16位的内存空间</span></span><br><span class="line"><span class="comment">// 特性：同步读写操作，支持从文件加载程序，提供内存就绪状态信号</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="keyword">module</span> memory_interface (</span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 系统控制信号</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">input</span> clk,                    <span class="comment">// 系统时钟信号，同步所有内存操作</span></span><br><span class="line">    <span class="keyword">input</span> reset,                  <span class="comment">// 全局复位信号，高电平有效，复位内存接口状态</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 处理器内存访问接口</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] address,         <span class="comment">// 16位内存地址总线，可寻址64K字空间 (0x0000-0xFFFF)</span></span><br><span class="line">    <span class="keyword">input</span> [<span class="number">15</span>:<span class="number">0</span>] data_in,         <span class="comment">// 16位内存写入数据总线，处理器要写入内存的数据</span></span><br><span class="line">    <span class="keyword">input</span> mem_read,               <span class="comment">// 内存读使能信号，高电平有效时执行读操作</span></span><br><span class="line">    <span class="keyword">input</span> mem_write,              <span class="comment">// 内存写使能信号，高电平有效时执行写操作</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内存响应信号</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] data_out,   <span class="comment">// 16位内存读取数据总线，从内存读取的数据输出</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> mem_ready          <span class="comment">// 内存操作完成标志，高电平表示当前操作已完成</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内存存储体定义 - 64Kx16位主内存</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 声明65536个16位存储单元，构成64K字的内存空间</span></span><br><span class="line">    <span class="comment">// 地址范围：0x0000 到 0xFFFF</span></span><br><span class="line">    <span class="comment">// 每个地址存储一个16位字，符合LC-3架构的字寻址特性</span></span><br><span class="line">    <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] memory [<span class="number">0</span>:<span class="number">65535</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内存初始化 - 从文件加载程序和数据</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 使用系统任务$readmemh从十六进制文件加载程序到内存</span></span><br><span class="line">        <span class="comment">// &quot;program.mem&quot;文件应包含LC-3机器码的十六进制表示</span></span><br><span class="line">        <span class="comment">// 文件格式：每行一个16位的十六进制值，从地址0开始顺序存储</span></span><br><span class="line">        <span class="built_in">$readmemh</span>(<span class="string">&quot;program.mem&quot;</span>, memory); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注意：在真实的FPGA实现中，可能需要使用不同的内存初始化方法</span></span><br><span class="line">        <span class="comment">// 例如使用Block RAM的初始化文件或硬编码的初始值</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="comment">// 内存访问控制逻辑 - 同步时序逻辑</span></span><br><span class="line">    <span class="comment">// =========================================================================</span></span><br><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> reset) <span class="keyword">begin</span></span><br><span class="line">        <span class="comment">// 复位处理：清除所有输出信号</span></span><br><span class="line">        <span class="keyword">if</span> (reset) <span class="keyword">begin</span></span><br><span class="line">            data_out &lt;= <span class="number">16&#x27;b0</span>;    <span class="comment">// 复位数据输出总线</span></span><br><span class="line">            mem_ready &lt;= <span class="number">1&#x27;b0</span>;    <span class="comment">// 复位内存就绪标志</span></span><br><span class="line">        <span class="keyword">end</span> </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 正常操作处理</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="comment">// 内存读操作处理</span></span><br><span class="line">            <span class="keyword">if</span> (mem_read) <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 从指定地址读取数据并输出到data_out总线</span></span><br><span class="line">                <span class="comment">// 注意：这里假设内存读取在一个时钟周期内完成</span></span><br><span class="line">                <span class="comment">// 在实际系统中，可能需要考虑内存访问延迟</span></span><br><span class="line">                data_out &lt;= memory[address];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置内存就绪标志，表示读操作已完成</span></span><br><span class="line">                mem_ready &lt;= <span class="number">1&#x27;b1</span>;</span><br><span class="line">            <span class="keyword">end</span> </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 内存写操作处理</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (mem_write) <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 将数据写入指定内存地址</span></span><br><span class="line">                <span class="comment">// 注意：写操作在时钟上升沿生效</span></span><br><span class="line">                memory[address] &lt;= data_in;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置内存就绪标志，表示写操作已完成</span></span><br><span class="line">                mem_ready &lt;= <span class="number">1&#x27;b1</span>;</span><br><span class="line">            <span class="keyword">end</span> </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 无内存操作状态</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                <span class="comment">// 清除内存就绪标志，表示当前没有进行中的内存操作</span></span><br><span class="line">                mem_ready &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 注意：data_out保持之前的值，直到下一次读操作</span></span><br><span class="line">                <span class="comment">// 这确保数据总线在非读操作期间保持稳定</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 模块功能详细说明</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">内存接口模块在LC-3系统中的作用：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1. 内存组织特性：</span></span><br><span class="line"><span class="comment">   - 64K字（128K字节）地址空间，符合LC-3架构规范</span></span><br><span class="line"><span class="comment">   - 字寻址（16位为单位），而非字节寻址</span></span><br><span class="line"><span class="comment">   - 大端序或小端序取决于具体实现（LC-3通常为大端序）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2. 访问时序：</span></span><br><span class="line"><span class="comment">   - 同步设计：所有操作在时钟上升沿同步进行</span></span><br><span class="line"><span class="comment">   - 单周期访问：假设内存可以在一个时钟周期内完成读写</span></span><br><span class="line"><span class="comment">   - 就绪信号：mem_ready指示操作完成，便于处理器流水线控制</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">3. 内存映射区域：</span></span><br><span class="line"><span class="comment">   在标准LC-3中，特定地址区域有特殊功能：</span></span><br><span class="line"><span class="comment">   - 0x0000-0x2FFF: 用户程序区域</span></span><br><span class="line"><span class="comment">   - 0x3000-0xFDFF: 用户数据区域  </span></span><br><span class="line"><span class="comment">   - 0xFE00-0xFFFF: 设备寄存器区域（内存映射IO）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">4. 文件加载机制：</span></span><br><span class="line"><span class="comment">   - 支持从program.mem文件加载初始程序</span></span><br><span class="line"><span class="comment">   - 文件格式：每行一个16位十六进制值</span></span><br><span class="line"><span class="comment">   - 典型用途：加载操作系统、用户程序或测试向量</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">5. 错误处理考虑：</span></span><br><span class="line"><span class="comment">   - 当前实现未包含地址越界检查</span></span><br><span class="line"><span class="comment">   - 在实际系统中可能需要添加访问权限检查</span></span><br><span class="line"><span class="comment">   - 对于不存在的内存区域应返回错误或默认值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 内存映射IO扩展示例</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// 如果需要支持内存映射IO，可以扩展模块如下：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">module memory_interface_with_io (</span></span><br><span class="line"><span class="comment">    input clk, reset,</span></span><br><span class="line"><span class="comment">    input [15:0] address, data_in,</span></span><br><span class="line"><span class="comment">    input mem_read, mem_write,</span></span><br><span class="line"><span class="comment">    output reg [15:0] data_out,</span></span><br><span class="line"><span class="comment">    output reg mem_ready,</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    // 设备接口</span></span><br><span class="line"><span class="comment">    input [15:0] kbsr_data,       // 键盘状态寄存器</span></span><br><span class="line"><span class="comment">    input [15:0] kbdr_data,       // 键盘数据寄存器  </span></span><br><span class="line"><span class="comment">    output reg [15:0] ddr_data,   // 显示数据寄存器</span></span><br><span class="line"><span class="comment">    output reg [15:0] dsr_data    // 显示状态寄存器</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    reg [15:0] memory [0:65535];</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    initial begin</span></span><br><span class="line"><span class="comment">        $readmemh(&quot;program.mem&quot;, memory);</span></span><br><span class="line"><span class="comment">    end</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    always @(posedge clk or posedge reset) begin</span></span><br><span class="line"><span class="comment">        if (reset) begin</span></span><br><span class="line"><span class="comment">            data_out &lt;= 16&#x27;b0;</span></span><br><span class="line"><span class="comment">            mem_ready &lt;= 1&#x27;b0;</span></span><br><span class="line"><span class="comment">            ddr_data &lt;= 16&#x27;b0;</span></span><br><span class="line"><span class="comment">            dsr_data &lt;= 16&#x27;b0;</span></span><br><span class="line"><span class="comment">        end else begin</span></span><br><span class="line"><span class="comment">            if (mem_read) begin</span></span><br><span class="line"><span class="comment">                // 内存映射IO处理</span></span><br><span class="line"><span class="comment">                case (address)</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE00: data_out &lt;= kbsr_data;  // 键盘状态</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE02: data_out &lt;= kbdr_data;  // 键盘数据</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE04: data_out &lt;= dsr_data;   // 显示状态</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE06: data_out &lt;= ddr_data;   // 显示数据</span></span><br><span class="line"><span class="comment">                    default: data_out &lt;= memory[address];</span></span><br><span class="line"><span class="comment">                endcase</span></span><br><span class="line"><span class="comment">                mem_ready &lt;= 1&#x27;b1;</span></span><br><span class="line"><span class="comment">            end else if (mem_write) begin</span></span><br><span class="line"><span class="comment">                // 内存映射IO处理</span></span><br><span class="line"><span class="comment">                case (address)</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE00: ; // KBSR只读</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE02: ; // KBDR只读</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE04: dsr_data &lt;= data_in;   // 写显示状态</span></span><br><span class="line"><span class="comment">                    16&#x27;hFE06: ddr_data &lt;= data_in;   // 写显示数据</span></span><br><span class="line"><span class="comment">                    default: memory[address] &lt;= data_in;</span></span><br><span class="line"><span class="comment">                endcase</span></span><br><span class="line"><span class="comment">                mem_ready &lt;= 1&#x27;b1;</span></span><br><span class="line"><span class="comment">            end else begin</span></span><br><span class="line"><span class="comment">                mem_ready &lt;= 1&#x27;b0;</span></span><br><span class="line"><span class="comment">            end</span></span><br><span class="line"><span class="comment">        end</span></span><br><span class="line"><span class="comment">    end</span></span><br><span class="line"><span class="comment">endmodule</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 使用示例和测试模式</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// 测试内存接口的简单测试平台：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">module test_memory_interface;</span></span><br><span class="line"><span class="comment">    reg clk, reset, mem_read, mem_write;</span></span><br><span class="line"><span class="comment">    reg [15:0] address, data_in;</span></span><br><span class="line"><span class="comment">    wire [15:0] data_out;</span></span><br><span class="line"><span class="comment">    wire mem_ready;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    memory_interface uut (</span></span><br><span class="line"><span class="comment">        .clk(clk), .reset(reset),</span></span><br><span class="line"><span class="comment">        .address(address), .data_in(data_in),</span></span><br><span class="line"><span class="comment">        .mem_read(mem_read), .mem_write(mem_write),</span></span><br><span class="line"><span class="comment">        .data_out(data_out), .mem_ready(mem_ready)</span></span><br><span class="line"><span class="comment">    );</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    // 时钟生成</span></span><br><span class="line"><span class="comment">    always #5 clk = ~clk;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    initial begin</span></span><br><span class="line"><span class="comment">        // 初始化</span></span><br><span class="line"><span class="comment">        clk = 0; reset = 1; </span></span><br><span class="line"><span class="comment">        mem_read = 0; mem_write = 0;</span></span><br><span class="line"><span class="comment">        address = 0; data_in = 0;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // 复位释放</span></span><br><span class="line"><span class="comment">        #10 reset = 0;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // 测试写操作</span></span><br><span class="line"><span class="comment">        #10 mem_write = 1; address = 16&#x27;h3000; data_in = 16&#x27;h1234;</span></span><br><span class="line"><span class="comment">        #10 mem_write = 0;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // 测试读操作  </span></span><br><span class="line"><span class="comment">        #10 mem_read = 1; address = 16&#x27;h3000;</span></span><br><span class="line"><span class="comment">        #10 mem_read = 0;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        // 验证读取的数据应为0x1234</span></span><br><span class="line"><span class="comment">        if (data_out === 16&#x27;h1234)</span></span><br><span class="line"><span class="comment">            $display(&quot;Test PASSED: Write and read successful&quot;);</span></span><br><span class="line"><span class="comment">        else</span></span><br><span class="line"><span class="comment">            $display(&quot;Test FAILED: Expected 0x1234, got 0x%h&quot;, data_out);</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        #10 $finish;</span></span><br><span class="line"><span class="comment">    end</span></span><br><span class="line"><span class="comment">endmodule</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 性能优化考虑</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. 访问延迟优化：</span></span><br><span class="line"><span class="comment">   - 当前设计假设单周期内存访问</span></span><br><span class="line"><span class="comment">   - 对于高速系统，可以考虑流水线内存访问</span></span><br><span class="line"><span class="comment">   - 对于大容量内存，可能需要多周期访问</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">2. 资源优化：</span></span><br><span class="line"><span class="comment">   - 在FPGA中，可以使用Block RAM替代分布式RAM</span></span><br><span class="line"><span class="comment">   - 对于大内存，可以分块实现并按需激活</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">3. 功耗优化：</span></span><br><span class="line"><span class="comment">   - 添加时钟门控，在不访问内存时关闭时钟</span></span><br><span class="line"><span class="comment">   - 实现内存分块，只激活被访问的内存区域</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">4. 错误检测：</span></span><br><span class="line"><span class="comment">   - 添加奇偶校验或ECC错误检测校正</span></span><br><span class="line"><span class="comment">   - 实现地址范围检查，防止越界访问</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">// 文件格式说明</span></span><br><span class="line"><span class="comment">// =============================================================================</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">program.mem 文件格式示例：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// LC-3机器码的十六进制表示</span></span><br><span class="line"><span class="comment">// 地址 0x0000: 程序起始</span></span><br><span class="line"><span class="comment">3000    // 0x3000: 程序起始地址（通常）</span></span><br><span class="line"><span class="comment">1261    // ADD R1, R1, #1</span></span><br><span class="line"><span class="comment">14A1    // ADD R2, R1, R1</span></span><br><span class="line"><span class="comment">F025    // TRAP HALT (系统调用停止)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 注释以//开始，空行被忽略</span></span><br><span class="line"><span class="comment">// 每行一个16位十六进制值，从地址0开始顺序存储</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/LC-3/" rel="tag"># LC-3</a>
              <a href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag"># C语言</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/05/04/Minecraft/" rel="prev" title="Minecraft">
                  <i class="fa fa-angle-left"></i> Minecraft
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/05/04/HSpice%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/" rel="next" title="HSpice的安装及其基本使用方法">
                  HSpice的安装及其基本使用方法 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">SiyuanLei</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
